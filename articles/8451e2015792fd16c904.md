---
title: "BigQueryã«ã‚·ãƒ³ã‚¯ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ç›£æŸ»ãƒ­ã‚°ã§ã‚ˆãä½¿ã†ã‚¯ã‚¨ãƒª5é¸"
emoji: "ğŸ“˜"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["bigquery", "adventcalendar"]
published: true
---

æ ªå¼ä¼šç¤¾ãƒãƒãƒ¼ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ã§ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã‚’ã—ã¦ã„ã‚‹å¤ªç”°ã§ã™ã€‚

[BigQuery Advent Calendar 2021](https://qiita.com/advent-calendar/2021/bigquery) 15æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚
https://qiita.com/advent-calendar/2021/bigquery

å½“åˆã€ã€ŒVPC Service Controlsã¨BigQueryã€ã‚’ãƒ†ãƒ¼ãƒã«è¨˜äº‹ã‚’æ›¸ã„ã¦ãŠã‚Šã¾ã—ãŸãŒå†…å®¹ã«èª¤ã‚ŠãŒã‚ã£ãŸãŸã‚ãƒ†ãƒ¼ãƒå¤‰æ›´ã—ã¦ãŠé€ã‚Šã—ã¾ã™ã€‚
å½“åˆã®ãƒ†ãƒ¼ãƒã®è¨˜äº‹ã¯å¾Œã»ã©å†…å®¹æ•´ãˆã¦åˆ¥é€”å…¬é–‹ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚
æ€¥é½ãƒ†ãƒ¼ãƒå¤‰æ›´ã—ãŸãŸã‚ã€è–„ã„å†…å®¹ã®è¨˜äº‹ã«ãªã£ã¦ã—ã¾ã£ãŸã“ã¨ã€ã‚¢ãƒ‰ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¨˜äº‹ã¨ã—ã¦å…¬é–‹ãŒé…ã‚ŒãŸã“ã¨ãŠè¨±ã—ãã ã•ã„ğŸ™

ã•ã¦ã€ä»Šå›ã¯BigQueryã«æºœã‚ãŸç›£æŸ»ãƒ­ã‚°ã‚’èª­ã‚€éš›ã«ã‚ãŸã—ãŒã‚ˆãä½¿ç”¨ã—ã¦ã„ã‚‹ã‚¯ã‚¨ãƒªã‚’ç´¹ä»‹ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

å€‹äººçš„ãªè©±ã‚’ã™ã‚‹ã¨ã€è¿‘å¹´ã¯åˆ†æå±‹å…¼ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢å°‚æ¥­ã«ã‚·ãƒ•ãƒˆã—ã¤ã¤ã‚ã‚Šã‚¯ã‚¨ãƒªã‚’æŠ•ã’ã‚‹æ©Ÿä¼šãŒæ¸›ã£ã¦ã„ãŸã‚Šã—ã¾ã™ã€‚
ä»Šå¹´ä¸€ç•ªãŠä¸–è©±ã«ãªã£ãŸãƒ†ãƒ¼ãƒ–ãƒ«ã¯ã€çµ„ç¹”ã§ã‚·ãƒ³ã‚¯ã—ã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ç›£æŸ»ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«ã ã£ãŸã“ã¨ã‚‚ã‚ã‚Šæ„Ÿè¬ã®æ„ã‚’è¾¼ã‚ã¦è¨˜äº‹ã«æ®‹ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

## å‰æ

- çµ„ç¹”é…ä¸‹ã®ã™ã¹ã¦ã®BigQueryã‚’ä½¿ç”¨ã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ç›£æŸ»ãƒ­ã‚°ã®åé›†ã‚’ã—ã¦ã„ã‚‹ã“ã¨
- åé›†ã—ãŸç›£æŸ»ãƒ­ã‚°ã‚’ç‰¹å®šã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®BigQueryã«ã‚·ãƒ³ã‚¯ã—ã¦ã„ã‚‹ã“ã¨
  - BigQueryã¸ã®ã‚·ãƒ³ã‚¯æ–¹æ³•ã«ã¤ã„ã¦ã¯å‰²æ„›ã—ã¾ã™
    - [BigQuery audit logs overview #Cloud Logging exports](https://cloud.google.com/bigquery/docs/reference/auditlogs/#stackdriver_logging_exports)

å¼Šç¤¾ã§ã¯ã€GCPãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼ˆçµ„ç¹”ï¼‰ã‚’Terraformã§ç®¡ç†ã—ã¦ãŠã‚Šã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç«‹ã¡ä¸Šã’æ™‚ã‹ã‚‰BigQueryå«ã‚€ã™ã¹ã¦ã®ã‚µãƒ¼ãƒ“ã‚¹ã«ãŠã„ã¦ã‚‚ã‚Œãªãç›£æŸ»ãƒ­ã‚°ã‚’åé›†ã—ã¦ã„ã¾ã™ã€‚

```hcl
resource "google_project_iam_audit_config" "default" {
  project = google_project.project.project_id
  service = "allServices"
  audit_log_config {
    log_type = "DATA_READ"
  }
  audit_log_config {
    log_type = "DATA_WRITE"
  }
  audit_log_config {
    log_type = "ADMIN_READ"
  }
}
```

## ã‚ˆãä½¿ã†ã‚¯ã‚¨ãƒª

### 1. ç‰¹å®šã®ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå‚ç…§ã•ã‚ŒãŸã‚¯ã‚¨ãƒªã®ä¸€è¦§ã‚’å–å¾—ã™ã‚‹

```sql
#standardSQL
SELECT
  protopayload_auditlog.authenticationInfo.principalEmail,
  timestamp,
  protopayload_auditlog.servicedata_v1_bigquery.jobGetQueryResultsResponse.job.jobConfiguration.query.query,
FROM
  `audit_sink_project.cloud_audit_logs.cloudaudit_googleapis_com_data_access_202111*`,
  UNNEST(protopayload_auditlog.servicedata_v1_bigquery.jobGetQueryResultsResponse.job.jobStatistics.referencedTables) AS t
WHERE
  1 = 1
  AND t.projectId = "project"
  AND t.datasetId = "dataset"
  AND t.tableId = "table"
```

`protopayload_auditlog.servicedata_v1_bigquery.jobGetQueryResultsResponse.job.jobStatistics.referencedViews`ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§å‚ç…§ã•ã‚ŒãŸãƒ“ãƒ¥ãƒ¼ã‚’å–å¾—ã™ã‚‹ã“ã¨ã‚‚å‡ºæ¥ã¾ã™ã€‚

### 2. ã‚ˆãåˆ©ç”¨ã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆä¸€è¦§ã‚’å–å¾—ã™ã‚‹

```sql
#standardSQL
SELECT
  REGEXP_EXTRACT(protopayload_auditlog.resourceName, '^projects/[^/]+/datasets/([^/]+)/tables') AS dataset_ref,
  COUNT(DISTINCT REGEXP_EXTRACT(protopayload_auditlog.resourceName, '^projects/[^/]+/datasets/[^/]+/tables/(.*)$')) AS active_tables,
  COUNTIF(JSON_EXTRACT(protopayload_auditlog.metadataJson, "$.tableDataRead") IS NOT NULL) AS read_events,
  COUNTIF(JSON_EXTRACT(protopayload_auditlog.metadataJson, "$.tableDataChange") IS NOT NULL) AS change_events,
FROM
  `audit_sink_project.cloud_audit_logs.cloudaudit_googleapis_com_data_access_202111*`
WHERE
  1 = 1
  AND (
    JSON_EXTRACT(protopayload_auditlog.metadataJson, "$.tableDataRead") IS NOT NULL
    OR JSON_EXTRACT(protopayload_auditlog.metadataJson, "$.tableDataChange") IS NOT NULL
  )
GROUP BY
  dataset_ref
ORDER BY
  read_events DESC
```

### 3. ãƒ†ãƒ¼ãƒ–ãƒ«ã”ã¨ã®æœ€çµ‚ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆå‚ç…§ã•ã‚ŒãŸï¼‰æ—¥æ™‚ã‚’å–å¾—ã™ã‚‹

```sql
#standardSQL
SELECT
  protopayload_auditlog.authenticationInfo.principalEmail,
  REGEXP_EXTRACT(protopayload_auditlog.resourceName, '^projects/[^/]+/datasets/([^/]+)/tables') AS dataset_ref,
  SPLIT(REGEXP_EXTRACT(protopayload_auditlog.resourceName, '^projects/[^/]+/datasets/[^/]+/tables/(.*)$'), '$')[OFFSET(0)] AS table_ref,
  MAX(timestamp) AS last_accessed_at,
FROM
  `audit_sink_project.cloud_audit_logs.cloudaudit_googleapis_com_data_access_202111*`
WHERE
  1 = 1
  AND JSON_EXTRACT(protopayload_auditlog.metadataJson, "$.tableDataRead") IS NOT NULL
GROUP BY
  principalEmail, dataset_ref, table_ref
ORDER BY
  last_accessed_at DESC
```

### 4. æœˆåˆ¥ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ã®ã‚¯ã‚¨ãƒªã‚³ã‚¹ãƒˆç¢ºèª

```sql
#standardSQL
SELECT
  TIMESTAMP_TRUNC(TIMESTAMP(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, "$.jobChange.job.jobStats.endTime")), MONTH) AS month,
  protopayload_auditlog.authenticationInfo.principalEmail,
  5.0 * (SUM(CAST(JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, "$.jobChange.job.jobStats.queryStats.totalBilledBytes") AS INT64)) / POWER(2, 40)) AS USD
FROM
  `audit_sink_project.cloud_audit_logs.cloudaudit_googleapis_com_data_access_202112*`
WHERE
  1 = 1
  AND JSON_EXTRACT_SCALAR(protopayload_auditlog.metadataJson, "$.jobChange.job.jobConfig.type") = "QUERY"
GROUP BY
  month,
  principalEmail
ORDER BY
  USD DESC
```

### 5. ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸã‚¯ã‚¨ãƒªã‚’ç‰¹å®šã™ã‚‹

```sql
SELECT
  protopayload_auditlog.authenticationInfo.principalEmail,
  resource.labels.project_id,
  timestamp,
  protopayload_auditlog.servicedata_v1_bigquery.jobCompletedEvent.job.jobConfiguration.query.query,
  protopayload_auditlog.servicedata_v1_bigquery.jobCompletedEvent.job.jobStatus.error.message,
FROM
  `audit_sink_project.cloud_audit_logs.cloudaudit_googleapis_com_data_access_202112*`
WHERE
  1 = 1
  AND protopayload_auditlog.methodName = 'jobservice.jobcompleted'
  AND severity = "ERROR"
ORDER BY
  timestamp DESC
```

## ãŠã¾ã‘

å…¬å¼ã®[BigQuery Audit Log Dashboard](https://github.com/GoogleCloudPlatform/professional-services/tree/master/examples/bigquery-audit-log)ã‚ªã‚¹ã‚¹ãƒ¡ã§ã™ã€‚
