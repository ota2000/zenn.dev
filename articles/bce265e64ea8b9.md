---
title: "Github Actionsã§Dataformã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã¨ãƒªãƒªãƒ¼ã‚¹æ§‹æˆã®æ›´æ–°ã‚’å®Ÿè¡Œã™ã‚‹"
emoji: "ðŸŽƒ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["dataform"]
published: true
---

## ã‚„ã£ãŸã“ã¨

- Dataformã®ãƒªãƒªãƒ¼ã‚¹ãƒ•ãƒ­ãƒ¼ã®å¤‰æ›´
  - å¤‰æ›´å¾Œ: mainãƒ–ãƒ©ãƒ³ãƒã«pushã—ãŸéš›ã«ã€Œã‚³ãƒ³ãƒ‘ã‚¤ãƒ«çµæžœã®ä½œæˆã€ã¨ã€Œãƒªãƒªãƒ¼ã‚¹æ§‹æˆã®æ›´æ–°ã€ã‚’å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«ã—ãŸ
  - å¤‰æ›´å‰: ãƒªãƒªãƒ¼ã‚¹æ§‹æˆã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®šã«å¾“ã„ã€ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã®æœ‰ç„¡ã«é–¢ã‚ã‚‰ãšå®šæ™‚å®Ÿè¡Œã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«çµæžœã®ä½œæˆã‚’è¡Œã£ã¦ã„ãŸ

## ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®yaml

- gcloud cliã«dataformé–¢é€£ãŒãªã„ã®ã§curlã§dataform.googleapis.comã‚’å©ã

```yaml
name: Dataform Create Compilation and Update Release Config

on:
  push:
    branches: main

env:
  WORKLOAD_IDENTITY_PROVIDER: "projects/hogehoge/locations/global/workloadIdentityPools/hogehoge-pool/providers/hogehoge-provider"
  SERVICE_ACCOUNT: "hogehoge@hogehoge.iam.gserviceaccount.com"
  PROJECT_ID: "hogehoge"
  REGION: "asia-northeast1"
  REPOSITORY: "hogehoge"
  RELEASE_CONFIG: "hogehoge"

jobs:
  compile-and-deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: "read"
      id-token: "write"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - id: auth
        uses: google-github-actions/auth@v2
        with:
          token_format: "access_token"
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER}}
          service_account: ${{ env.SERVICE_ACCOUNT }}
          project_id: ${{ env.PROJECT_ID }}

      - name: Create Compilation
        id: compilation
        run: |
          echo "name=$(curl -fs -X POST \
            'https://dataform.googleapis.com/v1beta1/projects/${{ env.PROJECT_ID }}/locations/${{ env.REGION }}/repositories/${{ env.REPOSITORY }}/compilationResults' \
            -H "Authorization: Bearer ${{ steps.auth.outputs.access_token }}" \
            -H 'Content-Type: application/json' \
            -d '{
                  "releaseConfig": "projects/${{ env.PROJECT_ID }}/locations/${{ env.REGION }}/repositories/${{ env.REPOSITORY }}/releaseConfigs/${{ env.RELEASE_CONFIG }}"
                }' | jq -c '.name')" >> $GITHUB_OUTPUT

      - name: Update Release Config
        run: |
          curl -fs -X PATCH \
          'https://dataform.googleapis.com/v1beta1/projects/${{ env.PROJECT_ID }}/locations/${{ env.REGION }}/repositories/${{ env.REPOSITORY }}/releaseConfigs/${{ env.RELEASE_CONFIG }}' \
          -H "Authorization: Bearer $(echo ${{ steps.auth.outputs.access_token }})" \
          -H 'Content-Type: application/json' \
          -d '{
                "gitCommitish": "main",
                "codeCompilationConfig": {
                  "vars": {
                      "env": "prod"
                  }
                },
                "timeZone": "Asia/Tokyo",
                "releaseCompilationResult": ${{ steps.compilation.outputs.name }}
              }'
```
